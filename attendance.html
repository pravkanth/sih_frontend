<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--      BOOTSTRAP CSS     -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!--      BOOTSTRAP JS      -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!--    FONT AWESOME    -->
    <script src="https://kit.fontawesome.com/47829851ea.js" crossorigin="anonymous"></script>

    <!--        CUSTOM CSS          -->
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./practice.css">
     <style>

     </style>
    <title>Document</title>
</head>

<body>
    <!--            NAVIGATION BAR              -->
        <nav>
            <div class="brand">
                <div class="logo">
                    <a href="./index.html"><img src="./images/lion-logo.png" alt="" id="nav-logo1"></a>
                    <a href="./index.html"><img src="./images/gandhi-logo.jpg" alt="" id="nav-logo2"></a>
                </div>
                <div class="title big-screen">
                    <p>THE MAHATMA GANDHI NATIONAL</p>
                    <p> RURAL EMPLOYMENT GUARANTEE ACT 2005</p>
                </div>
                <div class="title small-screen">
                   <a href="./index.html"><p style="color: black;">NGREA</p></a>
                </div>
            </div>
            <div class="nav-items">
                <button type="button" class="btn login-btn-nav"><a href="http://127.0.0.1:7863/">Image details</a></button>
            </div>
        </nav>
    <!--     XXX       NAVIGATION BAR        XXX      -->
    <div class="attendance-portal">
        <h1>Attendance Portal</h1>
        <div class="attendance-boxes">
            <div class="attendance-mainbox">
                <button class="" id="data-entry-btn">Data Entry</button>
                <button class="" id="upload-data-btn">Upload Data</button>
            </div>
            <div class="attendance-data-entry" id="attendance-data-entry">
                <input type="text" placeholder="Work code" id="work-code" value="111719107xxx">
                <input type="text" placeholder="MSR code" value="5767">
                <input type="text" placeholder="Latitude/Longitude" id="location-ll">
                <button class="btn btn-primary" id="show-worklist-button">Show Worker List</button>
            </div>
            <div class="upload-data-box" id="upload-data-box" style="display: none;">
                <h2>Total no of Workers present: <span id="present">0</span></h2>
                <h2>Total no of Person Detected: <span id="object-detected">0</span></h2>
                <table class="table mt-5" id="present-table">
                    <thead>
                        <tr>
                            <th scope="col">S.NO</th>
                            <th scope="col">Worker Name</th>
                            <th scope="col">WorkerId</th>
                            <th scope="col">Work code</th>
                            <th scope="col">Location</th>
                        </tr>
                    </thead>
                    <tbody id="present-table-body"></tbody>
                </table>
                <img src="" alt="" id="myimg">
            </div> 
        </div>
        <div class="upload-attendance-image" style="display: none;" id="upload-attendance-image">
            <a href=" http://127.0.0.1:7860/"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Image</a>
        </div>
        <table class="table mt-5" id="attendance-table" style="display: none; width: 80%; margin: auto;">
            <thead>
                <tr>
                    <th scope="col">S.NO</th>
                    <th scope="col">Worker Name</th>
                    <th scope="col">WorkerId</th>
                    <th scope="col">Date</th>
                    <th scope="col">Attendance</th>
                </tr>
            </thead>
            <tbody id="attendance-table-body">    </tbody>
        </table>

    </div>
    <div id="dvMap" style="width: 0px; height: 0px">

        <footer class="text-center text-white" style="background-color: #f1f1f1; margin-top: 2rem;">
            <!-- Grid container -->
            <div class="container pt-4">
                <!-- Section: Social media -->
                <section class="mb-4">
                    <!-- Facebook -->
                    <a class="btn btn-link btn-floating btn-lg text-dark m-1" href="#!" role="button"
                        data-mdb-ripple-color="dark"><i class="fab fa-facebook-f"></i></a>
        
                    <!-- Twitter -->
                    <a class="btn btn-link btn-floating btn-lg text-dark m-1" href="#!" role="button"
                        data-mdb-ripple-color="dark"><i class="fab fa-twitter"></i></a>
        
                    <!-- Google -->
                    <a class="btn btn-link btn-floating btn-lg text-dark m-1" href="#!" role="button"
                        data-mdb-ripple-color="dark"><i class="fab fa-google"></i></a>
        
                    <!-- Instagram -->
                    <a class="btn btn-link btn-floating btn-lg text-dark m-1" href="#!" role="button"
                        data-mdb-ripple-color="dark"><i class="fab fa-instagram"></i></a>
        
                    <!-- Linkedin -->
                    <a class="btn btn-link btn-floating btn-lg text-dark m-1" href="#!" role="button"
                        data-mdb-ripple-color="dark"><i class="fab fa-linkedin"></i></a>
                    <!-- Github -->
                    <a class="btn btn-link btn-floating btn-lg text-dark m-1" href="#!" role="button"
                        data-mdb-ripple-color="dark"><i class="fab fa-github"></i></a>
                </section>
                <!-- Section: Social media -->
            </div>
            <!-- Grid container -->
        
            <!-- Copyright -->
            <div class="text-center text-dark p-3" style="background-color: rgba(0, 0, 0, 0.2);">
                Â© 2022 Copyright:
                <a class="text-dark" href="https://mdbootstrap.com/">R.M.K. Engineering College</a>
            </div>
            <!-- Copyright -->
        </footer>
    <script src="./app.js"></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">
        
        const locationId = document.getElementById('location-ll')
        let text = ''
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (p) {
            var LatLng = new google.maps.LatLng(p.coords.latitude, p.coords.longitude);
            var mapOptions = {
                center: LatLng,
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById("dvMap"), mapOptions);
            var marker = new google.maps.Marker({
                position: LatLng,
                map: map,
                title: "<div style = 'height:60px;width:200px'><b>Your location:</b><br />Latitude: " + p.coords.latitude + "<br />Longitude: " + p.coords.longitude
            });
            text = `${p.coords.latitude} \\ ${p.coords.longitude}`
            locationId.value = text
            console.log(p.coords.latitude);
            console.log(p.coords.longitude);
            google.maps.event.addListener(marker, "click", function (e) {
                var infoWindow = new google.maps.InfoWindow();
                infoWindow.setContent(marker.title);
                infoWindow.open(map, marker);
            });
        });
    } else {
        alert('Geo Location feature is not supported in this browser.');
    }
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-app.js";
        import { getDatabase,ref,set,child,get,update,remove } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-database.js";

        let totalPersonCount = 0;
        const firebaseConfig = {
            apiKey: "AIzaSyBeDnlqVuzVpFHXWKhldRhpDcRNqsFoSrI",
            authDomain: "kalamfirebird.firebaseapp.com",
            databaseURL: "https://kalamfirebird-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kalamfirebird",
            storageBucket: "kalamfirebird.appspot.com",
            messagingSenderId: "584822980805",
            appId: "1:584822980805:web:a12fb2f187a95291eb70ac",
            measurementId: "G-DC150X0WY1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        import { getStorage,ref as sRef,uploadBytesResumable,getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/9.9.2/firebase-storage.js";
        
        const realDb = getDatabase();

        let myimg = document.getElementById('myimg');

        const objectDetected = document.getElementById('object-detected');


    function getDownloadURLFunc() {
        const storage = getStorage();
        const listRef = sRef(storage, '');
        let totalStorage = 0
        listAll(listRef)
            .then((res) => {
                totalStorage = res.items.length -1;
                getUrl(totalStorage)
            }).catch((error) => {
                // Uh-oh, an error occurred!
            });
         function getUrl(count){
            console.log(count);
            const starsRef = sRef(storage, `img${count}.png`);
             // Find all the prefixes and items.
             getDownloadURL(starsRef)
                 .then((url) => {
                    //  console.log(url);
                     SaveURLToRealtimeDB(url)
                     // Insert url into an <img> tag to "download"
                 })
                 .catch((error) => {
                     switch (error.code) {
                         case 'storage/object-not-found':
                             break;
                         case 'storage/unauthorized':
                             break;
                         case 'storage/canceled':
                             break;
                         case 'storage/unknown':
                             break;
                     }
                 });
         }

    }

    function SaveURLToRealtimeDB(URL) {

        // set(ref(realDb,"ImageLinks"+name),{
        //     ImageName :(name+ext),
        //     ImgUrl :URL
        // })
        set(ref(realDb, "ImageLinksdemo"), {
            ImageName: "test",
            ImgUrl: URL
        })

    }

    function getURLToRealtimeDB(URL) {
        let dbRef = ref(realDb);
        // get(child(dbRef, "ImageLinks" + name)).then((snapshot)=>{
        //     if(snapshot.exists()){
        //         myimg.src = snapshot.val().ImgUrl
        //     }
        // })
        get(child(dbRef, "ImageLinksdemo")).then((snapshot) => {
            if (snapshot.exists()) {
                myimg.src = snapshot.val().ImgUrl
            }
        })
         get(child(dbRef, "kalamfirebird")).then((snapshot) => {
            let totalPersonCountArr = []
            snapshot.forEach(childSnapShot =>{
                totalPersonCountArr.push(childSnapShot.val().TotalCount)
            })
            totalPersonCount = totalPersonCountArr[totalPersonCountArr.length - 1]
            objectDetected.textContent = totalPersonCount;
        })
    }
        document.getElementById('upload-data-btn').addEventListener('click',()=>{
            getDownloadURLFunc()
            getURLToRealtimeDB()
        })
    </script>
</body>

</html>

